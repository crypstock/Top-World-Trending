# app.py - Interfaz visual profesional con Streamlit para TopWorldTrending
import streamlit as st
import json
import os
from datetime import datetime

st.set_page_config(page_title="TopWorldTrending", layout="wide")
st.title("TopWorldTrending – Análisis de Productos en Tendencia")

# Barra lateral de navegación
menu = st.sidebar.selectbox("Selecciona una sección:", [
    "Página Principal",
    "Buscar Productos",
    "Tendencias IA",
    "Historial Guardado"
])

if menu == "Página Principal":
    st.subheader("Bienvenido a TopWorldTrending")
    st.markdown("""
    Esta herramienta busca, analiza y predice productos en tendencia usando inteligencia artificial.
    Puedes explorar productos en Amazon, eBay y Mercado Libre.
    """)
    st.image("https://i.imgur.com/UXSgIm2.png", use_column_width=True)

elif menu == "Buscar Productos":
    st.subheader("Buscar en múltiples plataformas")
    producto = st.text_input("Escribe el nombre del producto")
    plataforma = st.selectbox("Selecciona plataforma", ["Amazon (demo)", "eBay", "Mercado Libre"])
    if st.button("Buscar"):
        if plataforma == "eBay":
            from scripts.ebay_search import buscar_ebay
            resultados = buscar_ebay(producto, os.getenv("EBAY_APP_ID"))
        elif plataforma == "Mercado Libre":
            from scripts.mercado_libre import buscar_mercado_libre
            resultados = buscar_mercado_libre('MLM', producto)
        else:
            from scripts.amazon_search import buscar_amazon
            resultados = buscar_amazon(producto)

        if resultados:
            for r in resultados:
                st.markdown(f"### {r['titulo']}")
                st.markdown(f"**Precio:** ${r['precio']}")
                st.markdown(f"[Ver Producto]({r.get('url') or r.get('link')})")
                st.markdown("---")
        else:
            st.warning("No se encontraron resultados.")

elif menu == "Tendencias IA":
    st.subheader("Tendencias Analizadas por IA")
    from modules.ai_analyzer import analizar_productos
    data_dir = "data"
    tendencias = {}
    if os.path.exists(data_dir):
        productos = []
        for filename in os.listdir(data_dir):
            if filename.startswith("tendencias_") and filename.endswith(".json"):
                with open(os.path.join(data_dir, filename), "r") as f:
                    datos = json.load(f)
                    productos.append((filename, datos))

        if productos:
            for archivo, datos in productos:
                st.markdown(f"### {archivo}")
                for categoria, lista in datos.items():
                    st.markdown(f"**{categoria.upper()}**")
                    for item in lista:
                        st.markdown(f"- {item['producto']} ({item['veces']} veces)")
        else:
            st.info("Aún no hay archivos de tendencias generados.")

elif menu == "Historial Guardado":
    st.subheader("Historial de Archivos JSON Guardados")
    files = [f for f in os.listdir("data") if f.endswith(".json")]
    if files:
        archivo = st.selectbox("Selecciona archivo:", files)
        with open(os.path.join("data", archivo), "r") as f:
            contenido = json.load(f)
            st.json(contenido)
    else:
        st.warning("No hay archivos guardados aún.")

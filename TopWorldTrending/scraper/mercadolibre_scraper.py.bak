
import requests
from bs4 import BeautifulSoup
import pandas as pd
import datetime
import csv

class MercadoLibreScraper:
    def __init__(self):
        self.base_url = "https://listado.mercadolibre.com.mx"
        
    def scrape_products(self, query):
        url = f"{self.base_url}/{query.replace(' ', '-')}"
        response = requests.get(url)
        soup = BeautifulSoup(response.text, 'html.parser')
        results = soup.select("li.results-item, .ui-search-result")
        products = []
        
        for item in results[:10]:
            try:
                title_tag = item.select_one("h2, .ui-search-item__title")
                link_tag = item.select_one("a")
                price_tag = item.select_one(".price-tag-fraction")
                
                if title_tag and link_tag:
                    products.append({
                        "Title": title_tag.text.strip(),
                        "Price": f"${price_tag.text.strip()}" if price_tag else "N/A",
                        "Link": link_tag["href"],
                        "Date": datetime.date.today()
                    })
            except Exception:
                continue
                    
        df = pd.DataFrame(products)
        file_path = f"data/mercadolibre_{query}_MX_{datetime.date.today()}.csv"
        df.to_csv(file_path, index=False)
        return df

import requests
import datetime
import hashlib
import hmac

# Configura tus claves
ACCESS_KEY = 'TU_ACCESS_KEY'
SECRET_KEY = 'TU_SECRET_KEY'
ASSOCIATE_TAG = 'tuassociate-20'  # tu Amazon Associate ID
REGION = 'us-east-1'
SERVICE = 'ProductAdvertisingAPI'

# Función para firmar solicitudes (Amazon requiere autenticación v4)
def sign(key, msg):
    return hmac.new(key, msg.encode('utf-8'), hashlib.sha256).digest()

def getSignatureKey(key, dateStamp, regionName, serviceName):
    kDate = sign(('AWS4' + key).encode('utf-8'), dateStamp)
    kRegion = sign(kDate, regionName)
    kService = sign(kRegion, serviceName)
    kSigning = sign(kService, 'aws4_request')
    return kSigning

def buscar_amazon(producto='laptop'):
    method = 'GET'
    host = 'webservices.amazon.com'
    uri = '/paapi5/searchitems'
    endpoint = f'https://{host}{uri}'

    now = datetime.datetime.utcnow()
    amz_date = now.strftime('%Y%m%dT%H%M%SZ')
    date_stamp = now.strftime('%Y%m%d')

    payload = {
        "Keywords": producto,
        "SearchIndex": "All",
        "Resources": [
            "ItemInfo.Title",
            "Offers.Listings.Price",
            "Images.Primary.Medium"
        ],
        "PartnerTag": ASSOCIATE_TAG,
        "PartnerType": "Associates",
        "Marketplace": "www.amazon.com"
    }

    # Construcción del encabezado (firma AWS)
    canonical_headers = f'host:{host}\n'
    signed_headers = 'host'
    payload_hash = hashlib.sha256(str(payload).encode('utf-8')).hexdigest()
    canonical_request = f"{method}\n{uri}\n\n{canonical_headers}\n{signed_headers}\n{payload_hash}"

    algorithm = 'AWS4-HMAC-SHA256'
    credential_scope = f"{date_stamp}/{REGION}/{SERVICE}/aws4_request"
    string_to_sign = f"{algorithm}\n{amz_date}\n{credential_scope}\n{hashlib.sha256(canonical_request.encode('utf-8')).hexdigest()}"

    signing_key = getSignatureKey(SECRET_KEY, date_stamp, REGION, SERVICE)
    signature = hmac.new(signing_key, string_to_sign.encode('utf-8'), hashlib.sha256).hexdigest()

    authorization_header = (
        f"{algorithm} Credential={ACCESS_KEY}/{credential_scope}, "
        f"SignedHeaders={signed_headers}, Signature={signature}"
    )

    headers = {
        'Content-Type': 'application/json; charset=utf-8',
        'X-Amz-Date': amz_date,
        'Authorization': authorization_header
    }

    response = requests.post(endpoint, headers=headers, json=payload)
    return response.json()

# Prueba de búsqueda
if __name__ == "__main__":
    resultado = buscar_amazon('usb')
    print(resultado)
